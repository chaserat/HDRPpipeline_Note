# Unity资源管理（一）

## 现有问题

- 需要手动划分AssetBundle
- 很难做到最优，Bundle太大热更不友好，太小IO、内存不友好
- 维护成本高，很容易出现资源重复打包，循环依赖等问题

## 解决方案

- 散包合并
  - 每个Asset一个Bundle
  - 打包完成合并成一个或几个二进制大文件，通过Offset加载
  - 优点
    - 热更、IO友好
    - 内存能够精细控制
  - 缺点
    - Bundle内存、包体占用
    - 加载效率会降低（需要加载的Bundle数量会很庞大）
- 大AssetBundle
  - 所有资源（或者按找资源类型划分）打成一个大的AssetBundle
  - 优点
    - 加载速度快
    - AssetBundle内存占用少
  - 缺点
    - 内存控制比较复杂，需要手动精细管理（Prefab、SpriteAtlas）
    - 热更差异对比问题

## 测试

- 休闲游戏Demo
- 小米Mix2
- 压缩格式：LZ4

| 打包方式               | 整包（只拆出场景包）  | 整包（按照资源类型分包） | 散包                  |
| ---------------------- | --------------------- | ------------------------ | --------------------- |
| Bundle数量             | 3                     | 13                       | 755                   |
| 资源数量               | 961                   | 961                      | 961                   |
| 打包时间               | 00:59                 | 01:09                    | 05:23                 |
| 包体                   | 46.8 MB               | 46.7 MB                  | 62 MB                 |
| 内存（PSS）            | 432,984 KB            | 412,967 KB               | 458,340 KB            |
| 加载Bundl数量          | 2                     | 12                       | 386                   |
| 加载资源数量           | 77                    | 77                       | 77                    |
| 加载耗时（16）         | 0.36 + 0.93 = 1.29 秒 | 0.52 + 1.83 = 2.35 秒    | 2.69 + 2.38 = 5.07 秒 |
| 加载耗时（64）         | 0.39 + 0.81 = 1.20 秒 | 0.42 + 0.83 = 1.25 秒    | 0.81 + 1.17 = 1.98 秒 |
| 加载耗时（128）        | 0.38 + 0.60 = 0.98 秒 | 0.37 + 0.70 = 1.07 秒    | 0.73 + 1.01 = 1.74 秒 |
| 散包包外               |                       |                          | 1.01 + 1.28 = 2.29 秒 |
| 散包包外（二进制合并） |                       |                          | 0.71 + 0.79 = 1.50 秒 |

- 不压缩

| 打包方式        | 整包（只拆出场景包）  | 整包（按照资源类型分包） | 散包                  |
| --------------- | --------------------- | ------------------------ | --------------------- |
| 打包时间        | 00:58                 | 01:01                    | 05:18                 |
| 包体            | 90.1 MB               | 90.8 MB                  | 141.3 MB              |
| 加载耗时（128） | 0.37 + 0.49 = 0.86 秒 | 0.38 + 0.77 = 1.15 秒    | 0.68 + 1.01 = 1.69 秒 |

- DisableWriteTypeTree

| 打包方式        | 整包（只拆出场景包）  | 整包（按照资源类型分包） | 散包                 |
| --------------- | --------------------- | ------------------------ | -------------------- |
| 包体            | 47.6 MB               | 47.5 MB                  | 55.2 MB              |
| 内存（PSS）     | 421,897 KB            | 434,651 KB               | 459,907 KB           |
| 加载耗时（128） | 0.34 + 0.62 = 0.96 秒 | 0.38 + 0.67 = 1.05 秒    | 0.65 + 0.85 = 1.5 秒 |

## 分析

- LZ4压缩开销很小，加载耗时跟不压缩很接近
- 大量AssetBundle的情况下，TypeTree包体占用较大
- 散包
  - 包外加载耗时明显变高（第二次会变快，Android系统应该有缓存）
  - 包外二进制合并后加载耗时与散包包内加载耗时接近
  - 二进制合并不打TypeTree加载时检查Bundle格式会报错
  - 平均每个AssetBundle导致
    - 打包时间增加0.35秒
    - 包体增大10 KB
    - 内存增大100 KB
    - 加载耗时增加1.5毫秒
  
- 大AssetBundle
  - 打包速度快
  - 加载速度快
  - 内存、包体占用小


## 结论

- 散包的方式大量AssetBundle成本还是比较高
- 考虑采用大AssetBundle的方案
- 需要解决的问题
  - 内存精细控制
  - 热更Patch
